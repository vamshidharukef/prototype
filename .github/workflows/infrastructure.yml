name: Infrastructure üî®
run-name: Proto-type base infrastructure build from ${{ github.repository }}

on:
  push:
    branches:
      - main
env:
  PRODUCT: prototype
  ENVIRONMENT: infrastructure
  TIMEZONE: '${{ vars.TIMEZONE }}'
  # Deployment environment target i.e., `development`, `staging`, `production`
  TARGET: ${{ vars.ENVIRONMENT }}

jobs:
# 1. Setup infrastructure variables
  setup:
    name: Setup üîß
    runs-on: [self-hosted]
    outputs:
      environment: ${{ env.ENVIRONMENT }}
      timezone: ${{ env.TIMEZONE }}
    steps:
      - name: Environment üß™
        run: echo "Environment set to ${{ env.ENVIRONMENT }}"

      - name: Timezone üåê
        run: echo "Timezone set to ${{ env.TIMEZONE }}"

      - name: Login üîê
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} 

      - name: Azure defaults ‚ú®
        uses: azure/cli@v2
        with:
          inlineScript: |
            # Basic
            az configure --defaults location=${{ vars.REGION }}
            az configure --defaults group=rg-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }}

      - name: Resource group üèóÔ∏è
        uses: azure/cli@v2
        with:
          inlineScript: |
            az group create \
            --name rg-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }} \
            --tags ${{ env.TAGS }}

      - name: Plan üìù
        uses: azure/cli@v2
        with:
          inlineScript: |
            az appservice plan create \
            --name appservice-plan-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }} \
            --is-linux \
            --sku ${{ vars.APP_SERVICE_PLAN }} \
            --tags ${{ env.TAGS }}

      - name: Log analytics workspace üìù
        uses: azure/cli@v2
        with:
          inlineScript: |
            az monitor log-analytics workspace create \
            --name log-workspace-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }} \
            --quota ${{ vars.LOG_QUOTA }} \
            --retention-time ${{ vars.LOG_RETENTION_DAY }} \
            --sku ${{ vars.LOG_PLAN }} \
            --tags ${{ env.TAGS }}

      - name: Virtual network üßµ
        uses: azure/cli@v2
        with:
          inlineScript: |
            az network vnet create \
            --name vnet-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }} \
            --address-prefix ${{ vars.VNET_ADDRESS_PREFIX }} \
            --tags ${{ env.TAGS }}    

      - name: Subnets üí´
        uses: azure/cli@v2
        with:
          inlineScript: |
            # WebApp
            az network vnet subnet create \
            --name snet-webapp-${{ env.PRODUCT }}-${{ vars.VERSION }} \
            --address-prefixes ${{ vars.VNET_SUBNET_WEBAPP_PREFIX }} \
            --vnet-name vnet-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }}

            # Private endpoint
            az network vnet subnet create \
            --name snet-private-${{ env.PRODUCT }}-${{ vars.VERSION }} \
            --address-prefixes ${{ vars.VNET_SUBNET_PRIVATE_PREFIX }} \
            --vnet-name vnet-${{ env.PRODUCT }}-${{ env.TARGET }}-${{ vars.VERSION }} 

      - name: Deploy Azure Resources
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ secrets.AZURE_RESOURCE_GROUP }}
          template: ./infrastructure/main.bicep
          parameters: ./infrastructure/parameters.json                                     
  

      
